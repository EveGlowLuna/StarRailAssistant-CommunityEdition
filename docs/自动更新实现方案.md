# StarRailAssistant 自动更新实现方案

## 概述

实现 Tauri 应用的静默更新流程：应用退出 → 自动安装更新 → 安装完成后自动启动应用。

## 技术方案

### 方案选择：延迟脚本方案（方案 B）

**核心思路：**
1. Tauri 应用（已以管理员身份运行）创建临时批处理脚本
2. 脚本包含延迟逻辑，确保 Tauri 完全退出后再启动安装程序
3. 使用 `cmd /c start` 启动脚本（独立进程，不受父进程退出影响）
4. Tauri 应用退出
5. 脚本延迟后启动安装程序（继承管理员权限，无 UAC 弹窗）
6. 安装完成后自动启动新版本应用

---

## 实现细节

### 1. 安装程序参数

使用 Inno Setup 的静默安装参数：

```
/SILENT /SUPPRESSMSGBOXES /NORESTART /SP-
```

**参数说明：**
- `/SILENT` - 静默安装，显示进度但不需要用户交互
- `/SUPPRESSMSGBOXES` - 禁止所有消息框
- `/NORESTART` - 安装后不重启系统
- `/SP-` - 禁用"This will install... Do you wish to continue?"启动提示

### 2. 临时批处理脚本内容

```batch
@echo off
REM 延迟 2 秒，确保 Tauri 进程完全退出
ping 127.0.0.1 -n 3 >nul

REM 静默安装更新
start "" /wait "安装程序完整路径" /SILENT /SUPPRESSMSGBOXES /NORESTART /SP-

REM 安装完成后自动启动应用
start "" "应用程序完整路径"

REM 删除临时脚本自身
del "%~f0"
```

**关键点：**
- 使用 `ping` 命令实现延迟（`-n 3` 约等于 2 秒延迟）
- `/wait` 参数确保安装完成后再启动应用
- `%~f0` 是脚本自身的完整路径，用于自删除

### 3. Rust 实现伪代码

```rust
use std::fs;
use std::process::Command;
use std::env;

fn trigger_update_and_exit(installer_path: &str, app_path: &str) -> Result<(), Box<dyn std::error::Error>> {
    // 1. 获取临时目录
    let temp_dir = env::temp_dir();
    let script_path = temp_dir.join("sra_update.bat");
    
    // 2. 生成批处理脚本内容
    let script_content = format!(
        r#"@echo off
ping 127.0.0.1 -n 3 >nul
start "" /wait "{}" /SILENT /SUPPRESSMSGBOXES /NORESTART /SP-
start "" "{}"
del "%~f0"
"#,
        installer_path,
        app_path
    );
    
    // 3. 写入临时脚本
    fs::write(&script_path, script_content)?;
    
    // 4. 启动独立进程执行脚本
    Command::new("cmd")
        .args(["/c", "start", "", "/b", script_path.to_str().unwrap()])
        .spawn()?;
    
    // 5. 退出 Tauri 应用
    std::process::exit(0);
}
```

### 4. 路径示例

假设应用安装在默认位置：

```
安装程序路径: C:\Users\用户名\Downloads\StarRailAssistant_2.0.0_Setup.exe
应用程序路径: C:\Program Files\StarRailAssistant\StarRailAssistant.exe
临时脚本路径: C:\Users\用户名\AppData\Local\Temp\sra_update.bat
```

---

## 执行流程

```
用户点击"更新"按钮
    ↓
下载安装程序到临时目录
    ↓
生成临时批处理脚本
    ↓
启动脚本（独立进程）
    ↓
Tauri 应用退出
    ↓
[脚本延迟 2 秒]
    ↓
脚本启动安装程序（静默安装）
    ↓
[安装进行中...]
    ↓
安装完成
    ↓
脚本启动新版本应用
    ↓
脚本自删除
```

---

## 优势

1. **无 UAC 弹窗**：子进程继承 Tauri 的管理员权限
2. **无文件占用冲突**：延迟确保 Tauri 完全退出后再安装
3. **用户体验好**：全程静默，安装完自动启动
4. **实现简单**：只需要生成一个临时 bat 文件
5. **自清理**：脚本执行完自动删除

---

## 注意事项

1. **路径转义**：确保路径中的特殊字符正确处理（如空格需要用引号包裹）
2. **错误处理**：建议添加安装失败的回退逻辑
3. **权限检查**：启动前确认 Tauri 应用确实以管理员身份运行
4. **安装程序验证**：下载后验证安装程序的数字签名，防止恶意替换
5. **延迟时间**：2 秒通常足够，如果应用退出较慢可适当增加

---

## 可选优化

### 添加日志记录

```batch
@echo off
set LOG_FILE=%TEMP%\sra_update.log
echo [%date% %time%] 开始更新流程 >> %LOG_FILE%

ping 127.0.0.1 -n 3 >nul
echo [%date% %time%] 启动安装程序 >> %LOG_FILE%

start "" /wait "安装程序路径" /SILENT /SUPPRESSMSGBOXES /NORESTART /SP-
echo [%date% %time%] 安装完成 >> %LOG_FILE%

start "" "应用程序路径"
echo [%date% %time%] 应用已启动 >> %LOG_FILE%

del "%~f0"
```

### 添加错误处理

```batch
@echo off
ping 127.0.0.1 -n 3 >nul

start "" /wait "安装程序路径" /SILENT /SUPPRESSMSGBOXES /NORESTART /SP-

if %ERRORLEVEL% EQU 0 (
    start "" "应用程序路径"
) else (
    echo 安装失败，错误代码: %ERRORLEVEL% > %TEMP%\sra_update_error.txt
)

del "%~f0"
```

---

## 测试建议

1. 测试正常更新流程
2. 测试安装程序不存在的情况
3. 测试应用路径不存在的情况
4. 测试磁盘空间不足的情况
5. 测试在非管理员模式下的行为（应该提示需要管理员权限）
